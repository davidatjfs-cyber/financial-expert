# PDF 财务数据提取准确度提升指南

## 当前系统架构

系统使用以下技术栈提取 PDF 财务数据：
1. **pdfplumber** - 主要文本提取工具
2. **OCR (pytesseract)** - 处理扫描版或 CID 字体编码的 PDF
3. **正则表达式** - 从文本中提取财务数据

## 提升准确度的方法

### 方法一：使用 AI 大模型（推荐）

将 PDF 文本发送给 AI 大模型（如 GPT-4、Claude、通义千问）进行结构化提取。

**优点：**
- 准确度高，能理解上下文
- 自动适应不同格式的财报
- 无需维护正则表达式

**实现方式：**
```python
def extract_with_llm(pdf_text: str) -> dict:
    prompt = """
    请从以下财务报表文本中提取关键财务数据，返回 JSON 格式：
    {
        "revenue": 营业收入（数字，单位：百万元）,
        "net_profit": 净利润（数字，单位：百万元）,
        "total_assets": 总资产（数字，单位：百万元）,
        "total_equity": 股东权益（数字，单位：百万元）,
        "roe": ROE（百分比数字）,
        "roa": ROA（百分比数字）,
        "report_period": 报告期（格式：YYYY-MM-DD）
    }
    
    财务报表文本：
    {pdf_text}
    """
    # 调用 AI API
    response = call_llm_api(prompt)
    return json.loads(response)
```

**成本估算：**
- GPT-4: ~$0.03-0.10 / 份报表
- 通义千问: ~¥0.02-0.05 / 份报表

### 方法二：使用专业财务数据 API

接入第三方财务数据服务，直接获取结构化数据。

**推荐服务：**
- **Wind 万得** - 专业金融数据
- **东方财富 Choice** - A股数据
- **Tushare** - 免费/付费 A股数据
- **Yahoo Finance API** - 美股数据

**优点：**
- 数据准确、标准化
- 无需解析 PDF

**缺点：**
- 需要付费订阅
- 可能不支持所有公司

### 方法三：建立财报模板库

为常见的财报格式建立专门的解析模板。

**实现步骤：**
1. 收集主流财报格式（银行、科技、制造业等）
2. 为每种格式编写专门的解析规则
3. 自动识别财报类型并选择对应模板

```python
TEMPLATES = {
    "bank_quarterly": {
        "revenue": r"营业收入\s*([0-9,]+)",
        "net_profit": r"归属于.*股东的净利润\s*([0-9,]+)",
        "roe": r"加权平均净资产收益率[（(]年化[)）]\s*([0-9.]+)%",
    },
    "tech_annual": {
        "revenue": r"Total\s+revenues?\s*\$?\s*([0-9,]+)",
        "net_profit": r"Net\s+income\s*\$?\s*([0-9,]+)",
    }
}
```

### 方法四：用户反馈学习

允许用户修正提取结果，系统学习并改进。

**实现方式：**
1. 显示提取结果，允许用户编辑
2. 保存用户修正的数据
3. 分析修正模式，更新正则表达式

## 推荐方案

对于您的场景，推荐 **方法一（AI 大模型）+ 方法四（用户反馈）** 的组合：

1. **短期**：接入通义千问 API，成本低、中文支持好
2. **中期**：添加用户反馈功能，持续优化
3. **长期**：建立财报模板库，减少 AI 调用成本

## 配置 AI 提取

在 `.env` 文件中添加：
```
# 通义千问 API
DASHSCOPE_API_KEY=your_api_key

# 或 OpenAI API
OPENAI_API_KEY=your_api_key
```

然后在系统设置中启用「AI 智能提取」功能。

## 常见问题

### Q: 为什么某些 PDF 提取失败？
A: 可能原因：
- PDF 是扫描版（图片），需要 OCR
- PDF 使用特殊字体编码（CID 字体）
- 财报格式不在已知模板中

### Q: 如何添加新的财报格式支持？
A: 编辑 `core/pdf_analyzer.py`，在对应的 `find_first_number` 调用中添加新的正则表达式。

### Q: AI 提取的成本如何控制？
A: 
- 只对正则提取失败的报表使用 AI
- 缓存相同格式的提取结果
- 使用更便宜的模型（如通义千问-Turbo）
